<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="x-ua-compatible" content="IE=edge"></meta><meta name="format-detection" content="telephone=no"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"></meta><meta name="search" content="default"></meta><meta name="use.ic" content="no"></meta><meta name="tocstandalone" content="yes"></meta><meta name="theme" content="1"></meta><meta name="search.placeholder" content="Search"></meta><meta name="search.results" content="Search results"></meta><meta name="no.search.results" content="No results found"></meta><script type="text/javascript">
var theme = '1';

			
			var versionsfile = '';


			var indexDict = new Array();
			var store = {};
			var portalLanguage = 'en';
			var enterKey = 'select';
			
			
				var fuse_threshold = 0.3;
			
					var local_csh = false;
				
					var anchoroption = true;
				
			
			var useanchorlinks = false;
			
				useanchorlinks = true;
				
				var clicktocopy = 'Click to copy link';
				var linkcopied =  'Copied!';</script><title>Setting Up Multiple AWS Accounts using the New UI</title><link rel="stylesheet" type="text/css" href="../css/docbook.css"></link><link rel="stylesheet" type="text/css" href="../css/font-awesome.css"></link><link rel="stylesheet" type="text/css" href="../css/roboto.font.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1-colors.css"></link><link rel="stylesheet" type="text/css" href="../css/content-theme2.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-core-css.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-simple.css"></link><link rel="stylesheet" type="text/css" href="../css/style-print.css"></link><link rel="stylesheet" type="text/css" href="../css/style-common.css"></link><link rel="stylesheet" type="text/css" href="../css/style-modern-tables.css"></link><link rel="stylesheet" type="text/css" href="../css/rwd-table.min.css"></link><link rel="stylesheet" type="text/css" href="../css/graphical-lists.css"></link><link rel="stylesheet" type="text/css" href="../css/layout-custom-style.css"></link><script src="../js/jquery-3/jquery-3.4.1.min.js" type="text/javascript"></script><script src="../js/jquery-migrate-3.0.1.min.js" type="text/javascript"></script><script src="../js/materialize.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/purl.js" type="text/javascript"></script><script src="../js/jquery.smartmenus.js" type="text/javascript"></script><script src="js/toc.js" type="text/javascript"></script><script src="../js/create-toc.js" type="text/javascript"></script><script src="../js/html5-2-mp-common.js" type="text/javascript"></script><script src="../js/html5-2.js" type="text/javascript"></script><script src="../js/checklist.js" type="text/javascript"></script><script src="../js/rwd-table.min.js" type="text/javascript"></script><script src="../js/responsive-tables.js" type="text/javascript"></script><script src="../js/clipboard.min.js" type="text/javascript"></script><script src="../js/anchorlinks.js" type="text/javascript"></script><script src="../js/lunr.js" type="text/javascript"></script><script src="../js/jquery.mark.min.js" type="text/javascript"></script><script src="js/data.js" type="text/javascript"></script><script src="../js/search.js" type="text/javascript"></script><script src="../js/csh.js" type="text/javascript"></script><script src="../js/layout-custom-script.js" type="text/javascript"></script><meta name="generator" content="Paligo"></meta><link rel="prev" href="continuous-security-assessment-for-aws.html" title="Continuous Security Assessment for AWS"></link><link rel="next" href="setting-up-aws-instances-using-old-ui.html" title="Setting Up AWS Instances using Old UI"></link><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" async="async"></script><link rel="icon" href="/favicon.ico" type="image/x-icon"></link><script async="" src="https://www.googletagmanager.com/gtag/js?id=256425220"></script><script type="text/javascript">var propertyid = '256425220';

						window.dataLayer = window.dataLayer || [];
						function gtag(){dataLayer.push(arguments)};
						gtag('js', new Date());
						
						gtag('config', propertyid);
					</script><script type="text/javascript">
				$(document).ready(function () {
				$(".mediaobject img").addClass('materialboxed');
				//Exclude images with links
				$(".mediaobject a img").removeClass('materialboxed');
				if (!document.documentMode) {
				$('.materialboxed').materialbox();
				}});
			</script></head><body class="theme1 fixed-toolbar colored-top page-toc current-toc-section-focus" data-spy="scroll" data-target=".section-nav-container" data-offset="100" data-link-prefix=""><header class="site-header"><nav class="site-header-navbar navbar navbar-fixed-top"><div class="navbar-container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div id="logotype-container" class="pull-left"><a class="navbar-brand" href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div></div><div id="navbar" class="navbar-collapse collapse"></div></div></nav></header><div class="site-body"><div class="site-body-container"><div class="site-body-row"><aside class="site-sidebar"><div class="site-sidebar-header"><button type="button" class="navbar-toggle" aria-controls="nav-site-sidebar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div><form class="site-sidebar-search" autocomplete="off"><input type="text" class="form-control search-field" placeholder="Search" id="aa-search-input"></input></form><div id="toc-standalone-placeholder"></div></aside><div class="site-content"><h1 class="publication-title">Netskope Help</h1><div class="toolbar"><div class="toolbar-tools"><div id="navbar" class="navbar-collapse collapse"></div><div class="tool-print print-icon"><a onclick="window.print();return false;"><i class="fa fa-print" aria-hidden="true"><span class="print-text">print</span></i></a></div><div class="tool-search"><i class="fa fa-search" aria-hidden="true"></i></div><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div class="breadcrumb-container"><ul class="breadcrumb"><li class="breadcrumb-link"> <a href="index-en.html">Netskope Help</a></li><li class="breadcrumb-link"><a href="network-security.html">Network Security</a></li><li class="breadcrumb-link"><a href="netskope-public-cloud-security.html"><span class="phrase">Netskope Public Cloud Security</span></a></li><li class="breadcrumb-link"><a href="continuous-security-assessment-for-amazon-web-services.html">Continuous Security Assessment for Amazon Web Services</a></li><li class="breadcrumb-node">Setting Up Multiple AWS Accounts using the New UI</li></ul></div></div><main><div id="top-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="continuous-security-assessment-for-aws.html">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="setting-up-aws-instances-using-old-ui.html">Next</a></li></ul></div><article class="topic content-container" id="content-wrapper"><div id="topic-content" class="topic-content"><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-badb41d1-317d-4827-4682-fc9371288ad6" data-permalink="setting-up-multiple-aws-accounts-using-the-new-ui.html" data-topic-level="1" data-relative-prefix="" data-time-modified="December 16, 2020" data-publication-date="" id="UUID-8ae50cf1-2631-d87e-90f1-0e6a65808f95"><div class="titlepage"><div><div class="title"><h5 class="title">Setting Up Multiple AWS Accounts using the New UI</h5></div></div></div><p>Netskope has a new set up process to configure multiple AWS accounts with Netskope’s Public Cloud Security features such as Continuous Security Assessment and Storage Scan, which includes DLP Scan and Threat Protection (Malware Scan). The set up uses a Cloud Formation Template (CFT), <span class="bold bold"><strong>aws-instance-setup.yml</strong></span> that is customized with permissions required for Netskope for IaaS. These permissions vary depending on the services you want to enable on your AWS accounts.</p><p>For example, if you enable DLP Scan or Threat Protection (Malware Scan) on your accounts, then <span class="bold bold"><strong>aws-instance-setup.yml</strong></span> sets up cross-account access between Netskope and the AWS accounts to create a CloudWatch event stack called <span class="bold bold"><strong>NetskopeStack</strong></span> in all regions of the AWS accounts. This stack subscribes the AWS accounts to Netskope's notification receiver to receive CloudWatch events generated from write, update, and delete operations performed on S3 buckets in your AWS accounts. For more information, see <span class="emphasis"><em>"What happens in the process?"</em></span> section in <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4" title="Step 2/2: Permissions"><span class="xreftitle">Step 2/2: Permissions</span></a>.</p><p>The <span class="bold bold"><strong>Cloud Infrastructure</strong></span> pages in the Netskope UI provide details about all the events and scan results.</p><p>The new setup enables,</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Simplified bulk setup of multiple AWS accounts with Netskope for IaaS.</p></li><li class="listitem"><p>Scanning S3 buckets for DLP violations and malware with improved efficiency using CloudWatch events.</p></li></ul></div><div dir="ltr" class="important"><h3 class="title">Important</h3><p>IaaS Storage Scan (DLP and Threat Protection) feature does not support quarantine and legal hold functionalities. If you have configured a DLP or Malware quarantine profile with an external storage provider such as OneDrive, the file would be copied to that location. However, the file would not be removed from its original location in the public cloud storage, AWS S3.</p></div><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-8ae50cf1-2631-d87e-90f1-0e6a65808f95_section-idm4656990448473631604936702596"><div class="titlepage"><div><div class="title"><h6 class="title">Prerequisites</h6></div></div></div><p>Before you begin the setup process, ensure that:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>You make a list of AWS account numbers with their account names and admin email addresses you want to configure with Netskope for IaaS. Email address is optional.</p><p>An account name will help you easily identify the AWS account in the Netskope tenant.</p><div dir="ltr" class="note"><h3 class="title">Note</h3><p>Netskope recommends using the same account name as the AWS account alias. If an account alias is not available for the AWS account, then provide an account name for the AWS account.</p></div><p>For information on creating a list of AWS account numbers, see "Creating a CSV file" in <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a9a92cb1-41dd-86a1-90c8-f02f8bc0094b" title="Step 1/2: Accounts &amp; Services"><span class="xreftitle">Step 1/2: Accounts &amp; Services</span></a>.</p></li><li class="listitem"><p>A CloudWatch service is running on your AWS accounts. Storage Scan requires CloudWatch service to receive notifications.</p><p>For information on setting up CloudWatch, see the <a class="link" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/GettingSetup.html" target="_blank" rel="noopener">AWS documentation on CloudWatch</a>.</p></li><li class="listitem"><p>If you are enabling DLP Scan or Threat Protection (Malware Scan) on your accounts, then we recommend enabling object-level logging for S3 buckets. Enabling read and write data events for objects in the S3 bucket reduces delays in receiving event notifications.</p><p>For instructions on enabling object-level logging for S3 buckets, see the following AWS documentation links.</p><p><a class="link" href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/enable-cloudtrail-events.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/AmazonS3/latest/user-guide/enable-cloudtrail-events.html</a></p><p><a class="link" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerLogs.html#LogDeliveryBestEffort" target="_blank" rel="noopener">https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerLogs.html#LogDeliveryBestEffort</a></p><p><a class="link" href="https://www.netskope.com/blog/aws-s3-logjam-server-access-logging-vs-object-level-logging" target="_blank" rel="noopener">https://www.netskope.com/blog/aws-s3-logjam-server-access-logging-vs-object-level-logging</a></p></li></ul></div></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-0b13aa9f-3878-344e-b5d6-4783fbbccef4" data-time-modified="May 12, 2020" data-publication-date="" id="UUID-b1c66578-32b0-c7c9-607d-7e9fbd9a864b"><div class="titlepage"><div><div class="title"><h6 class="title">Implementation guide to set up AWS accounts in Netskope</h6></div></div></div><p><span class="bold bold"><strong>Are you a new customer? </strong></span></p><p>You can setup your AWS accounts in Netskope using one of the following methods:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Add AWS accounts to Netskope using the Netskope UI</p><p>This method requires you to:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Access the Netskope tenant,</p></li><li class="listitem"><p>Add your AWS accounts,</p></li><li class="listitem"><p>Select the Netskope for IaaS services you want to enable on these accounts and,</p></li><li class="listitem"><p>Download the CFT aws-instance-setup.yml.</p></li></ol></div></li><li class="listitem"><p>Using a REST API</p><p>This method requires a REST API token. You can call the following endpoint to add multiple AWS accounts to Netskope.</p><pre class="programlisting">https://<span class="emphasis"><em>&lt;tenant-name&gt;</em></span>.goskope.com/api/v1/public_cloud/account?token=<span class="emphasis"><em>&lt;token&gt;</em></span>&amp;op=create</pre><p>For more information on using this API endpoint see, .</p></li></ul></div><p><span class="bold bold"><strong>Are you an existing customer? </strong></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Migrate existing instances of AWS accounts by following the detailed instructions in <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-ff88d934-8f56-2761-8744-ca46615deedd" title="Migrate existing AWS accounts to the new set up"><span class="xreftitle">Migrate existing AWS accounts to the new set up</span></a>.</p></li><li class="listitem"><p>Setup new AWS accounts in Netskope using one of the following methods:</p><div class="itemizedlist" id="UUID-b1c66578-32b0-c7c9-607d-7e9fbd9a864b_itemizedlist-idm63177233195884"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Add AWS accounts to Netskope using the Netskope UI</p><p>This method requires you to:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Access the Netskope tenant,</p></li><li class="listitem"><p>Add your AWS accounts,</p></li><li class="listitem"><p>Select the Netskope for IaaS services you want to enable on these accounts and,</p></li><li class="listitem"><p>Download the CFT aws-instance-setup.yml.</p></li></ol></div></li><li class="listitem"><p>Using a REST API</p><p>This method requires a REST API token. You can call the following endpoint to add multiple AWS accounts to Netskope.</p><pre class="programlisting">https://<span class="emphasis"><em>&lt;tenant-name&gt;</em></span>.goskope.com/api/v1/public_cloud/account?token=<span class="emphasis"><em>&lt;token&gt;</em></span>&amp;op=create</pre><p>For more information on using this API endpoint see, .</p></li></ul></div></li></ol></div></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-b2fd37ea-a9d2-a437-9e02-9ca8cf04de53" data-time-modified="May 27, 2020" data-publication-date="" id="UUID-2d7b0ea4-a8fc-e720-9bea-4b9f9e60905d"><div class="titlepage"><div><div class="title"><h6 class="title">Add AWS accounts to Netskope using the Netskope UI</h6></div></div></div><p>To configure your AWS accounts with Netskope for IaaS, in the Netskope UI go to <span class="bold bold"><strong>Settings &gt; API-enabled Protection &gt; Cloud Infrastructure</strong></span>. Click <span class="bold bold"><strong>Setup</strong></span> and refer to the instructions in the following steps.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a9a92cb1-41dd-86a1-90c8-f02f8bc0094b" title="Step 1/2: Accounts &amp; Services"><span class="xreftitle">Step 1/2: Accounts &amp; Services</span></a></p></li><li class="listitem"><p><a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4" title="Step 2/2: Permissions"><span class="xreftitle">Step 2/2: Permissions</span></a></p></li></ol></div><div dir="ltr" class="note"><h3 class="title">Note</h3><p>If you want to modify or migrate the Netskope for IaaS services for existing AWS accounts that were configured using the old set up process, follow the instructions in <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-ff88d934-8f56-2761-8744-ca46615deedd" title="Migrate existing AWS accounts to the new set up"><span class="xreftitle">Migrate existing AWS accounts to the new set up</span></a>.</p></div><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-9d9b7d78-913e-a481-915c-c183067010e2" data-time-modified="May 15, 2020" data-publication-date="" id="UUID-a9a92cb1-41dd-86a1-90c8-f02f8bc0094b"><div class="titlepage"><div><div class="title"><h6 class="title">Step 1/2: Accounts &amp; Services</h6></div></div></div><p>On the Accounts &amp; Services screen provide your AWS account number, account name, and admin email address. Then enable the services you want to run on the AWS accounts.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Enter the AWS account number, account name, and admin email address in the text box. You can upload a CSV file with the account information, or enter them individually using the following format:</p><pre class="programlisting">123456789012,test,andrew@netskope.com
764389765412,develop
345689713654,production,timms@netskope.com
</pre><div dir="ltr" class="note"><h3 class="title">Note</h3><p>Account name is required to help you easily identify each account in the Netskope tenant. Email address is optional.</p></div><p>For information on how to create a CSV file, see <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a9a92cb1-41dd-86a1-90c8-f02f8bc0094b_section-idm4614953632276831606587658727" title="Creating a CSV file"><span class="xreftitle">Creating a CSV file</span></a>.</p></li><li class="listitem"><p>In the Services section, select the services you want to enable on the AWS accounts.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold bold"><strong>Security Assessment</strong></span>: Scans the AWS resources for misconfigurations and measures them against compliance benchmarks and best practices such as, CIS, PCI-DSS, NIST, and Netskope's recommended best practices.</p><p>You can view the compliance status of your resources in the <span class="bold bold"><strong>Cloud Infrastructure &gt; Overview</strong></span>, <span class="bold bold"><strong>Cloud Infrastructure &gt; Compliance</strong></span>, and <span class="bold bold"><strong>Cloud Infrastructure &gt; Inventory</strong></span> pages.</p><p>For information on configuring security assessment policies and rules, see the ??? documentation.</p></li><li class="listitem"><p><span class="bold bold"><strong>DLP Scan</strong></span>: Scans the S3 buckets for sensitive data and generates events when buckets are created, modified, or deleted. You can view the DLP Incidents in the <span class="bold bold"><strong>Cloud Infrastructure &gt; Overview</strong></span> ,  <span class="bold bold"><strong>SkopeIT &gt; Alerts</strong></span>, and <span class="bold bold"><strong>Incidents &gt; DLP</strong></span> pages.</p><p>DLP is a licensed feature. Contact <a class="link" href="mailto:Support@netskope.com" target="_blank">Support</a> and get the license to enable this feature in your tenant UI.</p><p>For information on using DLP policies, rules, and data identifiers to scan for DLP violations, see the <a class="xref" href="data-loss-prevention-104893.html" title="Data Loss Prevention"><span class="xreftitle">Data Loss Prevention</span></a> documentation.</p></li><li class="listitem"><p><span class="bold bold"><strong>Threat Protection (Malware Scan)</strong></span>: Scans the S3 buckets for malware. Threat Protection is a licensed feature. Contact <a class="link" href="mailto:Support@netskope.com" target="_blank">Support</a> and get the license to enable this feature in your tenant UI.</p><p>You can view the malware alerts in the <span class="bold bold"><strong>SkopeIT &gt; Alerts</strong></span> and <span class="bold bold"><strong>Incidents &gt; Malware</strong></span> pages.</p><p>For information on configuring a malware detection profile, see <a class="xref" href="create-a-malware-detection-profile.html" title="Create a Malware Detection Profile"><span class="xreftitle">Create a Malware Detection Profile</span></a>.</p></li></ul></div></li></ol></div><p>After providing the account information and selecting the services, proceed to <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4" title="Step 2/2: Permissions"><span class="xreftitle">Step 2/2: Permissions</span></a>.</p><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-a9a92cb1-41dd-86a1-90c8-f02f8bc0094b_section-idm4614953632276831606587658727"><div class="titlepage"><div><div class="title"><h6 class="title">Creating a CSV file</h6></div></div></div><p>An effortless way to add multiple AWS accounts in the setup screen is to create a CSV file with the account numbers, account names, and email addresses.</p><p>You can use Microsoft Excel or Google Sheets to create a CSV file. To get the list of AWS account numbers, account names, and email addresses using the AWS CLI, run the following command:</p><pre class="programlisting">aws --output=text organizations list-accounts | awk -F'\t' '{printf("%s,%s,%s\n",$4,$7,$3)}'</pre><p>The output of this command can then be copied to a spreadsheet in Microsoft Excel or Google Sheets and saved as a comma separated CSV, as shown in the screenshot.</p><div class="mediaobject"><img src="image/uuid-7d1a7f11-7b46-5456-a963-5d913d0f9621-en.png" style="" alt="excel-to-csv.png"></img></div><p>This CSV file can then be uploaded to the setup screen.</p></section></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-f5fff909-73ce-0d4e-11f0-e30c04f0b7a9" data-time-modified="July 22, 2020" data-publication-date="" id="UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4"><div class="titlepage"><div><div class="title"><h6 class="title">Step 2/2: Permissions</h6></div></div></div><p>Netskope requires permissions to perform certain actions in the AWS account such as assuming a role to scan your AWS resources, or creating a stack to receive CloudWatch events. This screen provides a customized CFT with permissions required to set up cross account access between Netskope and your AWS accounts. The permissions are defined in the CFT and differ based on the services you've enabled in the previous step.</p><p>You can review the CFT to understand the various permissions required by Netskope.</p><div dir="ltr" class="note"><h3 class="title">Note</h3><p>Ensure that the AWS accounts have the permissions required to run the Netskope for IaaS services.</p></div><p>To complete the set up you must:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Download the CFT.</p></li><li class="listitem"><p>Upload the CFT to a new CloudFormation stack in each AWS account.</p></li><li class="listitem"><p>Confirm that a cross account role with the required permissions is created.</p></li></ol></div><p>Follow the detailed instructions below to complete the set up.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the Permissions screen of the New Setup window, click the link to download the CFT.</p><div class="mediaobject"><img src="image/uuid-8df09f29-add1-e84e-99e1-1932813c9c84-en.png" style="" alt="multi-accountAWSsetup-1.png"></img></div></li><li class="listitem"><p>Log in to the AWS Management Console using the credentials of the AWS account you are setting up with Netskope for IaaS and navigate to <span class="bold bold"><strong>Services &gt; CloudFormation</strong></span>.</p></li><li class="listitem"><p>In the CloudFormation page, click <span class="bold bold"><strong>Create stack</strong></span>.</p><div class="mediaobject"><img src="image/uuid-996c28bd-776e-5203-dc4d-a8b8f1a1435d-en.png" style="" alt="create_stack.png"></img></div><p>To create a stack with new resources, choose <span class="bold bold"><strong>With new resources (standard)</strong></span>.</p><p>To create a stack with existing resources, choose <span class="bold bold"><strong>With existing resources (import resources)</strong></span>.</p></li><li class="listitem"><p>Select <span class="bold bold"><strong>Upload a template file</strong></span> and click <span class="bold bold"><strong>Choose file</strong></span> to upload the <span class="bold bold"><strong>aws-instance-setup.yml</strong></span>. Click <span class="bold bold"><strong>Next</strong></span>.</p><div class="mediaobject"><img src="image/uuid-edfa6337-d364-09f2-7e0d-6c8b5232db45-en.png" style="" alt="multi-accountAWSsetup-2.png"></img></div></li><li class="listitem"><p>In the Specify stack details page, specify a <span class="bold bold"><strong>Stack name</strong></span>. Click <span class="bold bold"><strong>Next</strong></span>.</p><p>The stack name must:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Only contain alphanumeric characters and hyphens,</p></li><li class="listitem"><p>start with an alphabet, and</p></li><li class="listitem"><p>not be longer than 128 characters.</p></li></ul></div></li><li class="listitem"><p>In the Configure stack options page, use the default configuration and click <span class="bold bold"><strong>Next</strong></span>.</p></li><li class="listitem"><p>Review your stack details on the <span class="bold bold"><strong>Review</strong></span> page, click the acknowledgment and then click <span class="bold bold"><strong>Create stack</strong></span>.</p><p>When the creation process is complete, your stack will be displayed on the CloudFormation page.</p><p>You can click on the stack to view the details about the stack. The Resources tab displays the various components that are part of <span class="bold bold"><strong>aws-instance-setup.yml</strong></span>. The Template tab displays the permissions defined in the template.</p></li><li class="listitem"><p>In the Netskope UI, confirm that a cross account role with permissions is created in each AWS account. Click <span class="bold bold"><strong>Add Accounts</strong></span>.</p><div class="mediaobject"><img src="image/uuid-a323bdd5-7b65-2f51-e678-e113ae9bfd2d-en.png" style="" alt="multi-accountAWSsetup-3.png"></img></div><p>Netskope adds the AWS accounts to the <span class="bold bold"><strong>Settings &gt; API-enabled Protection &gt; Cloud Infrastructure</strong></span> page. The page also displays the services that are enabled for each account.</p><div class="mediaobject"><img src="image/uuid-dad696fa-aeee-ca26-ade9-6c9a2df6a2c3-en.png" style="" alt="multi-accountAWSsetup-4.png"></img></div></li></ol></div><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4_section-idm4616737387249631610336552066"><div class="titlepage"><div><div class="title"><h6 class="title">What happens in the process?</h6></div></div></div><p>When DLP Scan or Threat Protection (Malware Scan) is enabled Netskope's <span class="bold bold"><strong>aws-instance-setup.yml</strong></span> creates a cross-account role in the AWS accounts which enables the CFT to create,</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>a new CloudFormation stack called <span class="bold bold"><strong>NetskopeStack</strong></span> in each region of this account where DLP Scan or Threat Protection (Malware Scan) is enabled.</p></li><li class="listitem"><p>CloudWatch event rules to monitor events in S3 buckets. Netskope creates and monitors the following rules,</p><p>RestoreObject, PutObject, PutObjectAcl, CopyObject, DeleteObject, CreateMultipartUpload, UploadPart, UploadPartCopy, CompleteMultipartUpload.</p></li><li class="listitem"><p>an SNS Topic, Policy, and Subscription to subscribe the AWS accounts to Netskope's endpoint URL. The endpoint is a notification receiver that receives CloudWatch events generated from write, update, and delete operations performed on S3 buckets in your AWS accounts.</p></li></ul></div><p>Netskope requires permissions to monitor and receive events from S3 buckets in your AWS accounts. The cross-account role creates two IAM policies, StorageScanPolicy and CloudFormationPolicy.</p><p>StorageScanPolicy is created with the following permissions,</p><div class="informaltable table-responsive"><table class="informaltable table-bordered"><thead><tr><th class="th" data-priority="1"><p>AWS Permissions for StorageScanPolicy</p></th><th class="th" data-priority="1"><p>Purpose</p></th></tr></thead><tbody><tr><td class="td"><p>s3:ListAllMyBuckets</p></td><td class="td"><p>This implementation of the GET operation returns a list of all buckets owned by the authenticated sender of the request.</p></td></tr><tr><td class="td"><p>s3:ListBucket</p></td><td class="td"><p>Lists a specific bucket</p></td></tr><tr><td class="td"><p>s3:GetObject</p></td><td class="td"><p>This implementation of the GET operation retrieves objects from Amazon S3.</p></td></tr><tr><td class="td"><p>s3:GetObjectAcl</p></td><td class="td"><p>This implementation of the GET operation uses the acl subresource to return the access control list (ACL) of an object.</p></td></tr><tr><td class="td"><p>s3:GetBucketLocation</p></td><td class="td"><p>This implementation of the GET operation uses the location subresource to return a bucket's region.</p></td></tr><tr><td class="td"><p>ec2:DescribeRegions</p></td><td class="td"><p>Describes one or more regions that are currently available to you.</p></td></tr></tbody></table></div><p>CloudFormationPolicy is created with the following permissions,</p><div class="informaltable table-responsive"><table class="informaltable table-bordered"><thead><tr><th class="th" data-priority="1"><p>AWS Permissions for CloudFormationPolicy</p></th><th class="th" data-priority="1"><p>Purpose</p></th></tr></thead><tbody><tr><td class="td"><p>cloudformation:DescribeStacks</p></td><td class="td"><p>Returns the description for the specified stack; if no stack name was specified, then it returns the description for all the stacks created.</p></td></tr><tr><td class="td"><p>sns:Publish</p></td><td class="td"><p>Sends a message to all endpoints a topic is subscribed to.</p></td></tr><tr><td class="td"><p>sns:Unsubscribe</p></td><td class="td"><p>Deletes a subscription.</p></td></tr><tr><td class="td"><p>sns:Subscribe</p></td><td class="td"><p>Prepares to subscribe an endpoint by sending the endpoint a confirmation message.</p></td></tr><tr><td class="td"><p>sns:ConfirmSubscription</p></td><td class="td"><p>Verifies an endpoint owner's intent to receive messages by validating the token sent to the endpoint by an earlier Subscribe action.</p></td></tr><tr><td class="td"><p>sns:SetTopicAttributes</p></td><td class="td"><p>Allows a topic owner to set an attribute of the topic to a new value.</p></td></tr><tr><td class="td"><p>sns:CreateTopic</p></td><td class="td"><p>Creates a topic to which notifications can be published.</p></td></tr><tr><td class="td"><p>sns:DeleteTopic</p></td><td class="td"><p>Deletes a topic and all its subscriptions.</p></td></tr><tr><td class="td"><p>sns:GetTopicAttributes</p></td><td class="td"><p>Returns all the properties of a topic.</p></td></tr><tr><td class="td"><p>events:DescribeRule</p></td><td class="td"><p>Describes the details of the specified rule.</p></td></tr><tr><td class="td"><p>events:ListRules</p></td><td class="td"><p>Lists the Amazon CloudWatch Events rules.</p></td></tr><tr><td class="td"><p>events:PutEvents</p></td><td class="td"><p>Sends custom events to Amazon CloudWatch Events so that they can be matched to rules.</p></td></tr><tr><td class="td"><p>events:EnableRule</p></td><td class="td"><p>Enables a rule.</p></td></tr><tr><td class="td"><p>events:PutRule</p></td><td class="td"><p>Creates or updates a rule.</p></td></tr><tr><td class="td"><p>events:PutTargets</p></td><td class="td"><p>Adds targets to a rule.</p></td></tr><tr><td class="td"><p>events:RemoveTargets</p></td><td class="td"><p>Removes targets from a rule so that when the rule is triggered, those targets will no longer be invoked.</p></td></tr><tr><td class="td"><p>events:DeleteRule</p></td><td class="td"><p>Deletes a rule.</p></td></tr><tr><td class="td"><p>sns:ListTopics</p></td><td class="td"><p>Returns a list of the requester's topics.</p></td></tr><tr><td class="td"><p>cloudformation:CreateStack</p></td><td class="td"><p>Creates a stack as specified in the template.</p></td></tr><tr><td class="td"><p>cloudformation:UpdateStack</p></td><td class="td"><p>Updates a stack as specified in the template.</p></td></tr><tr><td class="td"><p>cloudformation:DeleteStack</p></td><td class="td"><p>Deletes a specified stack.</p></td></tr></tbody></table></div><div dir="ltr" class="note"><h3 class="title">Note</h3><p>The <span class="bold bold"><strong>NetskopeStack</strong></span> is managed by Netskope and must not be manually updated.</p></div><p>When Security Assessment scan is enabled, Netskope assumes an IAM role which enables Netskope to scan for all the resources in your AWS environment. In this case, the CFT <span class="bold bold"><strong>aws-instance-setup.yml</strong></span> requires the following permissions to scan for resources.</p><div class="informaltable table-responsive"><table class="informaltable table-bordered"><thead><tr><th class="th" data-priority="1"><p>AWS Permissions for Security Assessment</p></th><th class="th" data-priority="1"><p>Purpose</p></th></tr></thead><tbody><tr><td class="td"><p>s3:ListBucket</p></td><td class="td"><p>Lists a specific bucket.</p></td></tr><tr><td class="td"><p>ses:ListIdentityPolicies</p></td><td class="td"><p>Returns a list of sending authorization policies that are attached to the given identity (an email address or a domain).</p></td></tr><tr><td class="td"><p>s3:GetBucketAcl</p></td><td class="td"><p>This implementation of the GET operation uses the acl subresource to return the access control list (ACL) of a bucket.</p></td></tr><tr><td class="td"><p>s3:GetBucketLocation</p></td><td class="td"><p>This implementation of the GET operation uses the location subresource to return a bucket's region.</p></td></tr><tr><td class="td"><p>s3:ListAllMyBuckets</p></td><td class="td"><p>This implementation of the GET operation returns a list of all buckets owned by the authenticated sender of the request.</p></td></tr><tr><td class="td"><p>dynamodb:ListTagsOfResource</p></td><td class="td"><p>Lists all tags on an Amazon DynamoDB resource.</p></td></tr><tr><td class="td"><p>sqs:ListDeadLetterSourceQueues</p></td><td class="td"><p>Returns a list of your queues that have the RedrivePolicy queue attribute configured with a dead letter queue.</p></td></tr><tr><td class="td"><p>sqs:GetQueueUrl</p></td><td class="td"><p>Returns a list of your queues.</p></td></tr><tr><td class="td"><p>sqs:GetQueueAttributes</p></td><td class="td"><p>Gets attributes for the specified queue.</p></td></tr><tr><td class="td"><p>lambda:Get*</p></td><td class="td"><p>Returns the specified alias information such as the alias ARN, description, and function version that the Lambda function is pointing to. Also returns the configuration information of the Lambda function and a presigned URL link.</p></td></tr><tr><td class="td"><p>lambda:List*</p></td><td class="td"><p>Returns list of aliases created for a Lambda function.</p><p>Returns a list of your Lambda functions.</p><p>Lists all versions of a function.</p></td></tr><tr><td class="td"><p>cloudwatch:GetMetricStatistics</p></td><td class="td"><p>Gets statistics for the specified metric.</p></td></tr></tbody></table></div></section></section></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-60827263-9638-052f-f2dd-9ace670794fb" data-time-modified="November 10, 2020" data-publication-date="" id="UUID-837c1dce-98ef-6fb4-c730-eb6743e20c4e"><div class="titlepage"><div><div class="title"><h6 class="title">Scanning S3 Buckets encrypted with KMS keys</h6></div></div></div><p>You must configure your AWS environment to provide Netskope with the necessary permissions to enable storage scan on S3 Buckets that are encrypted with KMS keys.</p><p>To provide the required permissions to Netskope, copy the IAM role created by Netskope's CFT into each KMS key policy and provide the specified Sid, Action and Condition.</p><p>Follow these detailed instructions.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log in to the AWS Management Console using the credentials of the AWS account you are setting up with Netskope for IaaS and navigate to <span class="bold bold"><strong>Services &gt; IAM &gt; Roles</strong></span>.</p></li><li class="listitem"><p>Under Roles, search for <span class="bold bold"><strong>Netskope_Role</strong></span> and copy the Role ARN for this role.</p></li><li class="listitem"><p>Navigate to <span class="bold bold"><strong>Services &gt; Key Management Service</strong></span>.</p></li><li class="listitem"><p>Under <span class="bold bold"><strong>Customer managed keys</strong></span> go to each KMS key used to encrypt S3 Buckets and edit the Key policy.</p></li><li class="listitem"><p>Under the Key policy of each KMS key, click <span class="bold bold"><strong>Edit</strong></span>.</p></li><li class="listitem"><p>Edit the <span class="bold bold"><strong>Statement</strong></span> section of the policy to include the following:</p><pre class="programlisting">{
            "Sid": "Enable Netskope to use KMS via S3",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::&lt;customer_account_id&gt;:role/Netskope_Role"
            },
            "Action": "kms:Decrypt",
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "kms:ViaService": "s3.us-west-1.amazonaws.com"
                }
            }
        }</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Edit the Sid to <span class="bold bold"><strong>Enable Netskope to use KMS via S3</strong></span>.</p></li><li class="listitem"><p>Paste the Role ARN of <span class="bold bold"><strong>Netskope_Role</strong></span> under AWS.</p></li><li class="listitem"><p>Edit Action to <span class="bold bold"><strong>kms:Decrypt</strong></span>.</p></li><li class="listitem"><p>Add the Condition as provided above.</p><p>The condition key ensures that Netskope does not perform any action directly on the KMS key but only through the S3 managed service.</p><div dir="ltr" class="note"><h3 class="title">Note</h3><p>Since KMS can only encrypt buckets in the same region as the key ensure that kms:ViaService matches the region of the KMS key.</p></div></li></ul></div></li><li class="listitem"><p>Save the key policy changes as <span class="bold bold"><strong>AWS-KMS</strong></span>.</p></li></ol></div></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-8864b5b8-d3b3-0393-09f5-1609d8613269" data-time-modified="May 15, 2020" data-publication-date="" id="UUID-4519cdf2-b7a0-5757-a29f-375a73f3e2a0"><div class="titlepage"><div><div class="title"><h6 class="title">Post set up updates</h6></div></div></div><p>You can change or modify the email address and, add or remove services from AWS accounts in the Netskope UI. When you add or remove services from an account, a new CFT is generated with updated permissions. The new CFT must be uploaded to the CloudFormation stack in the AWS account to update the account with the service changes. However, changing only the email address does not generate a new CFT and does not require you to update the CloudFormation stack.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the <span class="bold bold"><strong>Settings &gt; API-enabled Protection &gt; Cloud Infrastructure</strong></span> page, click on the AWS account to view the edit screen.</p></li><li class="listitem"><p>If you only want to edit the email address, provide the new Admin email and click <span class="bold bold"><strong>Save</strong></span>.</p><p>If you have added or removed services on this screen, download the new CFT and update the CloudFormation stack in the AWS accounts. For instructions on how to update the stack, see <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-4519cdf2-b7a0-5757-a29f-375a73f3e2a0_section-idm4531670245500831610354701455" title="Updating the stack"><span class="xreftitle">Updating the stack</span></a>.</p></li><li class="listitem"><p>Confirm that a cross account role with permissions is created in each AWS account. Click <span class="bold bold"><strong>Save</strong></span>.</p></li></ol></div><p>Alternatively, you can use Netskope's REST API to update a Netskope instance of the AWS account.</p><pre class="programlisting">https://&lt;tenant-name&gt;.goskope.com/api/v1/public_cloud/account?token=&lt;token&gt;&amp;op=update</pre><p>For more information on REST API endpoints see, <a class="xref" href="public-cloud-api-endpoints.html" title="Public Cloud API Endpoints"><span class="xreftitle">Public Cloud API Endpoints</span></a>.</p><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-4519cdf2-b7a0-5757-a29f-375a73f3e2a0_section-idm4531670245500831610354701455"><div class="titlepage"><div><div class="title"><h6 class="title">Updating the stack</h6></div></div></div><p>When a new CFT is generated in the Netskope UI, you must update the CloudFormation stack with the latest CFT. To update the stack,</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into the AWS Management Console and navigate to the CloudFormation page.</p></li><li class="listitem"><p>Click on the stack you created previously to upload the CFT.</p></li><li class="listitem"><p>In the stack page, click <span class="bold bold"><strong>Update</strong></span>.</p><div class="mediaobject"><img src="image/uuid-c0a17303-a98a-c85f-6642-bbfb0df8ed08-en.png" style="" alt="multi-accountAWSsetup-5.png"></img></div></li><li class="listitem"><p>In the Update stack page, select <span class="bold bold"><strong>Replace current template</strong></span> and under Specify Template, select <span class="bold bold"><strong>Upload a template file</strong></span>.</p><div class="mediaobject"><img src="image/uuid-1a378bca-0de7-4a69-39a3-4f91bfe84757-en.png" style="" alt="multi-accountAWSsetup-6.png"></img></div></li><li class="listitem"><p>Click <span class="bold bold"><strong>Choose file</strong></span> to upload the new <span class="bold bold"><strong>aws-instance-setup.yml</strong></span>. Click <span class="bold bold"><strong>Next</strong></span>.</p></li><li class="listitem"><p>Click <span class="bold bold"><strong>Next</strong></span> on the Specify stack details page and the Configure stack options page.</p></li><li class="listitem"><p>Review your stack details on the <span class="bold bold"><strong>Review</strong></span> page and click <span class="bold bold"><strong>Update stack</strong></span>.</p></li></ol></div></section></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-3c718459-c318-9bdb-7e1c-e796d87efdb6" data-time-modified="May 15, 2020" data-publication-date="" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd"><div class="titlepage"><div><div class="title"><h6 class="title">Migrate existing AWS accounts to the new set up</h6></div></div></div><p>If you have existing AWS accounts in your Netskope tenant that use the old set up where DLP and malware scans are performed using CloudTrail events, then you can migrate them to the new set up which uses CloudWatch events to efficiently scan your resources for DLP violations and malware.</p><p>You can use one of the following methods to migrate your accounts.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_N1587084905023"><p><a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4554778600416031741635094502" title="Bulk migrate using migration_script.py"><span class="xreftitle">Bulk migrate using <code class="literal">migration_script.py</code></span></a></p></li><li class="listitem"><p><a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4568085658176031741635417598" title="Manually migrate each account using aws-instance-setup.yml"><span class="xreftitle">Manually migrate each account using <code class="literal">aws-instance-setup.yml</code></span></a></p></li></ul></div><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4554778600416031741635094502"><div class="titlepage"><div><div class="title"><h6 class="title">Bulk migrate using <code class="literal">migration_script.py</code></h6></div></div></div><p>You can run the script, <code class="literal">migration_script.py</code> to migrate several accounts at the same time. The script requires you to create a CSV file with the following information,</p><pre class="programlisting">&lt;instance_name&gt;,&lt;api_token&gt;,&lt;tenant_url&gt;,&lt;aws_access_key_id&gt;,&lt;aws_secret_key&gt;,&lt;aws_region&gt;
&lt;instance_name&gt;,&lt;api_token&gt;,&lt;tenant_url&gt;,&lt;aws_access_key_id&gt;,&lt;aws_secret_key&gt;,&lt;aws_region&gt;</pre><p>where,</p><p><code class="literal">&lt;instance_name&gt;</code> is the name of the AWS account instance in the Netskope tenant.</p><p><code class="literal">&lt;api_token&gt;</code> is the REST API token from the Netskope tenant under <span class="bold bold"><strong>Settings &gt; Tools &gt; REST API</strong></span>.</p><p><code class="literal">&lt;tenant_url&gt;</code> is the Netskope tenant URL.</p><p><code class="literal">&lt;aws_access_key_id&gt;</code> and <code class="literal">&lt;aws_secret_key&gt;</code> are the keys from the AWS account.</p><p><code class="literal">&lt;aws_region&gt;</code> is the AWS region in which you want the script to upload the migration CFT, <code class="literal">aws-instance-setup.yml</code>. For information about the steps performed by the script, see <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4601666045758431743266588481" title="About migration_script.py"><span class="xreftitle">About <code class="literal">migration_script.py</code></span></a>.</p><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4601666045758431743266588481"><div class="titlepage"><div><div class="title"><h6 class="title">About <code class="literal">migration_script.py</code></h6></div></div></div><p>This script, <code class="literal">migration_script.py</code> performs the following steps.</p><div class="procedure" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_procedure-idm456810528643363174326701984"><ol class="procedure" type="1"><li class="step"><p>Reads the CSV file and verifies that the instance for the AWS account exists in the specified Netskope tenant.</p></li><li class="step"><p>Uses the API token to call the REST API and download the migration CFT, <code class="literal">aws-instance-setup.yml</code>. The template is customized based on the Netskope Public Cloud services enabled for the account.</p></li><li class="step"><p>Uses the provided AWS access key and secret key to connect to the AWS account and creates a stack called <span class="bold bold"><strong>netskopeCAR</strong></span> in the specified AWS region.</p></li><li class="step"><p>Uploads <code class="literal">aws-instance-setup.yml</code> to <span class="bold bold"><strong>netskopeCAR</strong></span> stack. When the stack creation is complete, the AWS accounts have been migrated to the new set up.</p></li></ol></div><p>For information on <code class="literal">aws-instance-setup.yml</code> and the background process, see <span class="emphasis"><em>"What happens in the process?"</em></span> section in <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4" title="Step 2/2: Permissions"><span class="xreftitle">Step 2/2: Permissions</span></a>.</p></section><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4601666050513631743249502121"><div class="titlepage"><div><div class="title"><h6 class="title">Run <code class="literal">migration_script.py</code></h6></div></div></div><p>To run <code class="literal">migration_script.py</code>,</p><div class="procedure" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_procedure-idm4601665460656031743250348227"><ol class="procedure" type="1"><li class="step"><p>Create a file called <code class="literal">migration_script.py</code> and copy the following script into the file.</p><pre class="programlisting">import argparse
import requests
import time
import csv
import json
import boto3
import random
from botocore.exceptions import ClientError
import concurrent.futures
from datetime import datetime


STACK_UP_TO_DATE = 'No updates are to be performed'
STACK_NOT_EXIST = 'does not exist'
MAX_RETRIES = 8
MIN_STACK_WAIT = 1
MAX_STACK_WAIT = 10
CLOUDFORMATION_SERVICE = 'cloudformation'
STACK_NAME = 'netskopeCAR'
STACK_SUCC_STATES = ['CREATE_COMPLETE','UPDATE_COMPLETE']
IN_PROGRESS = 'IN_PROGRESS'
ROLLED_BACK = 'ROLLBACK_COMPLETE'
FAILED = 'FAILED'
STACKS = 'Stacks'
STACK_STATUS = 'StackStatus'
STACK_ID = 'StackId'
STACK_STATUS_REASON = 'StackStatusReason'

APP = "aws"
PATH = "/api/v1/public_cloud/account"


def get_instance(hostname, app, instance_name, token):
    """
    Get instance details
    :param hostname: tenant host
    :param app: app name 'aws'
    :param instance_name: name of the instance
    :param token: REST API token
    :return: instance details or Exception
    """
    print("Getting info for {}".format(instance_name))
    params = {
        "app": app,
        "instance_name": instance_name,
        "token": token
    }
    headers = { "Content-Type" : "application/json", "Accept" : "application/json" }
    get_response = requests.get("https://{}/api/v1/introspection_instance".format(hostname), headers=headers, params=params, verify=False)
    response_data = {}
    json_output = json.loads(get_response.text)
    if json_output.get("status") == "error":
        raise Exception('Errors: {}'.format(json_output.get("errors")))
    response_data["use_for"] = json_output["data"]["instance"]["use_for"]
    response_data["admin_email"] = json_output["data"]["instance"]["admin_email"]
    if "securityscan" in response_data["use_for"]:
        response_data["securityscan_interval"] =  json_output["data"]["instance"]["securityscan_interval"]
    print("Returning info for name {}: {}".format(instance_name, response_data))
    return response_data

def download_cft(hostname, token, app, instance_name, admin_email, usefor, securityscan_interval):
    """
    call the download of the migration CFT for the instance
    :param hostname: tenant host
    :param token: REST API token
    :param app: app name 'aws'
    :param instance_name: instance name
    :param admin_email: admin email for the instance
    :param usefor: services used by the instance
    :param securityscan_interval: security scan interval
    :return: CFT content or Exception
    """
    print("Downloading Migration Template for {}".format(instance_name))
    qparams = {"token":token, "op":"download"}
    headers = { "Content-Type" : "application/json" }
    data = {
        "app": app,
        "type": "cft",
        "use_for": usefor,
        "mode" : "migrate",
        "admin_email" : admin_email,
        "instance_name": instance_name,
        "securityscan_interval": securityscan_interval
    }
    res = requests.post("https://{}{}".format(hostname, PATH), headers=headers, params=qparams, data=json.dumps(data), verify=False)
    response = res.text
    if response.startswith("{"):
        json_output = json.loads(response)
        if json_output.get("status") == "error":
            raise Exception('For instance "{}" errors received: {}'.format(instance_name, json_output.get("errors")))
    return response

def create_resource(instance_name, region, access_key, secret_key, template):
    """
    Call stack creation and wait the stack creation to be completed
    :param instance_name: name of the instance
    :param region: region in which the stack will be created
    :param access_key: access key id for target aws account
    :param secret_key: secret key for the target aws account
    :param template: CFT template
    :return: Exception if encountered
    """
    try:
        print("creating stacks....")
        client = boto3.client(CLOUDFORMATION_SERVICE,
                                    aws_access_key_id=access_key,
                                    aws_secret_access_key=secret_key,
                                    region_name=region)
        if not stack_exists(client, STACK_NAME, region):
            print("stack does not exist, creating stack")
            response = client.create_stack(
                StackName=STACK_NAME,
                TemplateBody=template,
                Capabilities=['CAPABILITY_NAMED_IAM']
            )
            now = datetime.now()
            start_time = datetime.timestamp(now)
        else:
            raise Exception("Stack already present for instance: {}".format(instance_name))
        print("Waiting Stack creation to be completed for {}".format(instance_name))
        while True:
            time.sleep(random.randint(MIN_STACK_WAIT, MAX_STACK_WAIT))
            stacks = client.describe_stacks(StackName=response[STACK_ID])
            stack_status = stacks[STACKS][0][STACK_STATUS]
            if stack_status in STACK_SUCC_STATES:
                print("Stack creation for {} was successful".format(instance_name))
                break
            if IN_PROGRESS not in stack_status:
                if stack_status == ROLLED_BACK or FAILED in stack_status:
                    reason = stacks[STACKS][0].get(STACK_STATUS_REASON)
                    if reason:
                        raise Exception("Exception received while creating stack {} for instance : {} , {}".format(STACK_NAME, instance_name, reason))
                    else:
                        raise
            current_time = datetime.timestamp(datetime.now())
            if start_time + 600 &lt; current_time:
                raise Exception("Stack creation for {} took longer than expected, please check the AWS console".format(instance_name))
    except ClientError as exc:
        if STACK_UP_TO_DATE not in str(exc):
            raise
        else:
            print("{} Stack {} already up to date and no updates are to be performed".format(instance_name, STACK_NAME))
    except Exception as exc:
        raise

def stack_exists(client, name, region):
    """
    Check if the stack with the provided name is already present
    :param client: client
    :param name: name of the stack
    :param region: region in which the stack is to be deployed
    :return: true if stack exists
    """
    try:
        while True:
            stacks = client.describe_stacks(StackName=name)
            stack_status = stacks[STACKS][0][STACK_STATUS]
            if 'IN_PROGRESS' in stack_status:
                time.sleep(random.randint(MIN_STACK_WAIT, MAX_STACK_WAIT))
            elif ROLLED_BACK == stack_status or FAILED in stack_status:
                print("Stack in {} state. Stack cannot be recovered, triggering\
                     deleting stack in region : {}".format(stack_status, region))
                client.delete_stack(StackName=STACK_NAME)
                time.sleep(random.randint(MIN_STACK_WAIT, MAX_STACK_WAIT))
            else:
                return True
    except ClientError as exc:
        if STACK_NOT_EXIST in str(exc):
            return False
        else:
            raise

def start_migration(row):
    """
    Caller method for gathering the instance details
    call methods for
    Getting instance details
    Download migration CFT
    call creation of stack
    :param row: single row containing the instance details
    :return:
    """
    details = {
            "instance_name": row[0],
            "apitoken": row[1],
            "tenant_url": row[2],
            "access_key_id" : row[3],
            "secret_key": row[4],
            "region": row[5]
    }
    hostname = details["tenant_url"]
    instance_name = details["instance_name"]
    apitoken = details["apitoken"]
    region = details["region"]
    access_key_id = details["access_key_id"]
    secret_key = details["secret_key"]
    try:
        response_data = get_instance(hostname, APP, instance_name, apitoken)
        use_for = response_data["use_for"]
        admin_email = response_data["admin_email"]
        securityscan_interval = response_data.get("securityscan_interval")
        print("{}, {}".format(use_for, admin_email))
        cft_yaml_body = download_cft(hostname, apitoken, APP, instance_name,
                                     admin_email, use_for, securityscan_interval)
        create_resource(instance_name, region, access_key_id, secret_key, cft_yaml_body)
        print('Migration triggered successfully for : {}'.format(instance_name))
    except Exception as exc:
        return "For {} Exception received : {}".format(instance_name, str(exc))

if __name__ == "__main__":
    """
    Customer will create and provide location of the csv file from which each instance
    migration will be triggered. Migration contains the following parts
    1-&gt; get instance details for the instance
    2-&gt; download migration CFT for the instance
    3-&gt; trigger create of stack with the downloaded CFT
    4-&gt; Wait for the stack creation to be completed
    5-&gt; post success or failure of the migration
    """
    PARSER = argparse.ArgumentParser()
    PARSER.add_argument("--file", help="csv file", required=True)
    ARGS = PARSER.parse_args()
    file_path = ARGS.file
    results = []
    if str(file_path).endswith(".csv"):
        with open(file_path) as f:
            reader = csv.reader(f)
            with concurrent.futures.ThreadPoolExecutor(max_workers=200) as executor:
                futures = [executor.submit(start_migration, row) for row in reader]
                for idx, future in enumerate(concurrent.futures.as_completed(futures)):
                    try:
                        res = future.result(timeout=600)
                        results.append(res)
                    except concurrent.futures._base.TimeoutError as exc:
                        print("timeout_error {} {}".format(str(exc), future))
        print("FAILED RESULTS : {}".format(results))
    else:
        print("Expected a csv file and file path: {} is not a csv file".format(file_path))
</pre></li><li class="step"><p>Open a CLI and at the prompt run,</p><pre class="programlisting">python migration_script.py --file &lt;path-to-csv&gt;</pre></li></ol></div></section></section><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4568085658176031741635417598"><div class="titlepage"><div><div class="title"><h6 class="title">Manually migrate each account using <code class="literal">aws-instance-setup.yml</code></h6></div></div></div><p>You can migrate one account at a time by downloading <code class="literal">aws-instance-setup.yml</code> and uploading it to a new CloudFormation stack in the AWS account.</p><p>To download <code class="literal">aws-instance-setup.yml</code> call the following REST API.</p><pre class="programlisting">https://&lt;tenant-name&gt;.goskope.com/api/v1/public_cloud/account?token=&lt;token&gt;&amp;op=download</pre><p>For more information on REST API endpoints see, <a class="xref" href="public-cloud-api-endpoints.html" title="Public Cloud API Endpoints"><span class="xreftitle">Public Cloud API Endpoints</span></a>.</p><p>If you want to download <code class="literal">aws-instance-setup.yml</code> through the Netskope tenant,</p><div class="procedure" id="UUID-ff88d934-8f56-2761-8744-ca46615deedd_procedure-idm4568105152731231741782901004"><ol class="procedure" type="1"><li class="step"><p>Go to <span class="bold bold"><strong>Settings &gt; API-enabled Protection &gt; Cloud Infrastructure</strong></span> page, click on the AWS account to view the edit screen.</p></li><li class="step"><p>Click <span class="bold bold"><strong>Start Migration</strong></span> and download the CFT, <code class="literal">aws-instance-setup.yml</code> from the migrate account screen.</p></li></ol></div><p>After you've downloaded <code class="literal">aws-instance-setup.yml</code> , you must create a new CloudFormation stack in the AWS account and upload the template. For detailed instructions on creating a stack and uploading the template, see <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4" title="Step 2/2: Permissions"><span class="xreftitle">Step 2/2: Permissions</span></a>.</p></section></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-8eb98797-ef86-9008-089a-16884f2dc177" data-time-modified="June 19, 2020" data-publication-date="" id="UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237"><div class="titlepage"><div><div class="title"><h6 class="title">Automatically add new accounts to Netskope</h6></div></div></div><p>This feature enables you to add new AWS accounts to the Netskope tenant using the AWS Management Console. The setup requires a CFT, <code class="literal">add_accounts_cft.yml</code> which calls Netskope's REST API to create an instance of the AWS account in the tenant. The CFT can be used along with an existing AWS script in your environment such as automatic AWS account creation and resource provisioning to provide you the benefit of automatically setting up your new AWS accounts in the Netskope tenant.</p><p>The CFT contains a script that calls the following REST APIs to create and manage AWS accounts in the Netskope tenant.</p><pre class="programlisting">https://&lt;tenant-name&gt;.goskope.com/api/v1/public_cloud/account?token=&lt;token&gt;&amp;op=create
https://&lt;tenant-name&gt;.goskope.com/api/v1/public_cloud/account?token=&lt;token&gt;&amp;op=update
https://&lt;tenant-name&gt;.goskope.com/api/v1/public_cloud/account?token=&lt;token&gt;&amp;op=delete</pre><div dir="ltr" class="note"><h3 class="title">Note</h3><p>For more information on REST API endpoints see, <a class="link" href="public-cloud-api-endpoints.html" title="Public Cloud API Endpoints">IaaS APIs</a>.</p></div><p>This setup requires you to perform the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4646577699496031739621375452" title="Create the CFT file"><span class="xreftitle">Create the CFT file</span></a></p></li><li class="listitem"><p><a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4666905054798431739621554144" title="Import the CFT to AWS Management Console"><span class="xreftitle">Import the CFT to AWS Management Console</span></a></p></li></ol></div><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4646577699496031739621375452"><div class="titlepage"><div><div class="title"><h6 class="title">Create the CFT file</h6></div></div></div><p>Create a file called <code class="literal">add_accounts_cft.yml</code> and copy the following contents into the file.</p><pre class="programlisting">Description: CrossAccountRole creation Template
Parameters:
  APIToken:
    Type: String
    Description: Enter REST API token for the tenant
  TenantUrl:
    Type: String
    Description: Enter the tenant url
  AccountName:
    Type: String
    Description: AWS account alias(if present) else human readable name
  AdminEmail:
    Type: String
    Description: Enter admin email
  SecurityScan:
    Type: String
    Default: 'true'
    Description: 'Enter ( "true", "false" ), whether security scan is enabled.'
    AllowedValues:
      - true
      - false
  DLPScan:
    Type: String
    Default: 'true'
    Description: 'Enter ( "true", "false" ), whether DLP Scan is enabled.'
    AllowedValues:
      - true
      - false
  MalwareScan:
    Type: String
    Default: 'false'
    Description: 'Enter ( "true", "false" ), whether Malware Scan is enabled'
    AllowedValues:
      - true
      - false
  SecurityScanInterval:
    Type: String
    Default: '60'
    Description: Select security scan interval
    AllowedValues:
      - '30'
      - '60'
      - '120'
      - '360'
      - '1440'
  TrustedAccountID:
    Type: String
    Description: Enter the account ID provided by Netskope.
  ExternalID:
    Type: String
    Description: Enter the external ID provided by Netskope.
Conditions:
  StorageScanEnabled: !Or
    - !Equals 
      - 'true'
      - Ref: DLPScan
    - !Equals
      - 'true'
      - Ref: MalwareScan
  SecurityScanEnabled: !Equals 
    - 'true'
    - Ref: SecurityScan
  AnyFeatureEnabled: !Or 
    - !Equals 
      - 'true'
      - !Ref DLPScan
    - !Equals 
      - 'true'
      - !Ref SecurityScan
Outputs:
  CrossRoleAccountRoleARN:
    Description: The cross-account role that Netskope will use.
    Value: !GetAtt 
      - CrossAccountRole
      - Arn
Resources:
  AutoAddInstance:
    Condition: AnyFeatureEnabled
    Properties:
      ServiceToken: !GetAtt 
        - AutoAddInstanceCall
        - Arn
      adminemail: !Ref AdminEmail
      accountname: !Ref AccountName
      apitoken: !Ref APIToken
      securityscan: !Ref SecurityScan
      introspection: !Ref DLPScan
      malware: !Ref MalwareScan
      securityscaninterval: !Ref SecurityScanInterval
      tenanturl: !Ref TenantUrl
      sspolicy:
        Fn::If:
        - StorageScanEnabled
        - Ref: StorageScanPolicy
        - Ref: AWS::NoValue
      cfpolicy:
        Fn::If:
        - StorageScanEnabled
        - Ref: CloudFormationPolicy
        - Ref: AWS::NoValue
      scpolicy:
        Fn::If:
        - SecurityScanEnabled
        - Ref: SecurityScanRolePolicy
        - Ref: AWS::NoValue
    Type: 'Custom::AutoAddInstance'
  AutoAddInstanceCall:
    Condition: AnyFeatureEnabled
    Properties:
      Code:
        ZipFile: |
          import boto3
          import json
          import time
          import ssl
          from urllib.request import Request, urlopen
          def send(event, context, responseStatus, responseData,
          physicalResourceId=None, noEcho=False):
              responseUrl = event['ResponseURL']
              responseBody = {}
              responseBody['Status'] = responseStatus
              responseBody['Reason'] = 'See the details in CloudWatch Log Stream: ' + context.log_stream_name
              responseBody['PhysicalResourceId'] = physicalResourceId or context.log_stream_name
              responseBody['StackId'] = event['StackId']
              responseBody['RequestId'] = event['RequestId']
              responseBody['LogicalResourceId'] = event['LogicalResourceId']
              responseBody['NoEcho'] = noEcho
              responseBody['Data'] = responseData
              json_responseBody = json.dumps(responseBody)
              try:
                  req = Request(responseUrl, method='PUT')
                  req.add_header('Content-Type', 'application/json; charset=utf-8')
                  jsondataasbyte = json_responseBody.encode("utf-8")
                  req.add_header('Content-Length', len(jsondataasbyte))
                  response = urlopen(req, jsondataasbyte)
              except Exception as e:
                  print("send(..) failed executing requests.put(..): " + str(e))
          def handler(event, context):
              properties = event.get('ResourceProperties', {})
              tenant_url = properties['tenanturl']
              api_token = properties['apitoken']
              account_id = properties["ServiceToken"].split(':')[4]
              instance_name = properties['accountname']
              time.sleep(30)
              request_body = {
                  "app": "aws",
                  "instance_name": instance_name,
              }
              request_url = "https://{}/api/v1/public_cloud/account?token={}&amp;op={}".format(tenant_url, api_token, '{}')
              if event['RequestType'] == 'Delete':
                  request_url = request_url.format('delete')
              else:
                  services = []
                  if properties["introspection"] == "true":
                    services.append("introspection")
                  if properties["securityscan"] == "true":
                    services.append("securityscan")
                  if properties["malware"] == "true":
                    services.append("malware")
                  request_body["use_for"] = services
                  admin_email = properties["adminemail"]
                  if 'securityscan' in services:
                      request_body["securityscan_interval"] = properties['securityscaninterval']
                  if 'Create' == event['RequestType']:
                      request_url = request_url.format('create')
                      request_body['accounts'] = [{
                          'account_id': account_id,
                          'account_name': instance_name,
                          'admin_email': admin_email
                      }]
                  elif event['RequestType'] == 'Update':
                      request_body["admin_email"] = admin_email
                      request_url = request_url.format('update')
              request_body = json.dumps(request_body)
              count = 3
              while count:
                  try:
                      print(request_url)
                      req = Request(request_url)
                      req.add_header('Content-Type', 'application/json; charset=utf-8')
                      jsondataasbyte = request_body.encode("utf-8")
                      req.add_header('Content-Length', len(jsondataasbyte))
                      response = urlopen(req, jsondataasbyte, context=ssl._create_unverified_context(), timeout=30)
                      resp = {"data": response.read().decode("utf-8")}
                      print("RESPONSE: {}".format(resp))
                      if "status" in resp["data"]:
                         json_resp  = json.loads(resp["data"])
                         status = json_resp.get("status")
                         if status != "success":
                            send(event, context, "FAILED", resp, 'autoaddaccounts')
                            break
                      print("wait for 2 mins")
                      time.sleep(120)
                      send(event, context, "SUCCESS", resp, 'autoaddaccounts')
                      break
                  except Exception as exc:
                      print("Response exc : {}".format(str(exc)))
                      if count &gt; 0:
                         count -= 1
                      if count == 0:
                         send(event, context, "FAILED", str(exc), 'autoaddaccounts')
      FunctionName: AutoAddInstanceCall
      Handler: index.handler
      Role: !GetAtt 
        - NSLambdaAccessRole
        - Arn
      Runtime: python3.7
      Timeout: 240
    Type: 'AWS::Lambda::Function'
  CloudFormationPolicy:
    Condition: StorageScanEnabled
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'cloudformation:CreateStack'
              - 'cloudformation:UpdateStack'
              - 'cloudformation:DeleteStack'
            Condition:
              'ForAllValues:Null':
                'cloudformation:RoleArn': true
            Effect: Allow
            Resource:
              - '*'
          - Action:
              - 'cloudformation:DescribeStacks'
              - 'sns:Publish'
              - 'sns:Subscribe'
              - 'sns:SetTopicAttributes'
              - 'sns:CreateTopic'
              - 'sns:DeleteTopic'
              - 'sns:ListTopics'
              - 'sns:GetTopicAttributes'
              - 'events:DescribeRule'
              - 'events:ListRules'
              - 'events:PutEvents'
              - 'events:EnableRule'
              - 'events:PutRule'
              - 'events:PutTargets'
              - 'events:RemoveTargets'
              - 'events:DeleteRule'
            Effect: Allow
            Resource:
              - 'arn:aws:cloudformation:*:*:stack/NetskopeStack/*'
              - 'arn:aws:sns:*:*:*'
              - 'arn:aws:events:*:*:rule/NetskopeStack*'
        Version: 2012-10-17
      PolicyName: CloudFormationPolicy
      Roles:
        - !Ref CrossAccountRole
    Type: 'AWS::IAM::Policy'
  CrossAccountRole:
    Condition: AnyFeatureEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalID
            Effect: Allow
            Principal:
              AWS: !Join 
                - ''
                - - 'arn:aws:iam::'
                  - !Ref TrustedAccountID
                  - ':root'
            Sid: ''
        Version: 2012-10-17
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/SecurityAudit'
      Path: /
      RoleName: Netskope_Role
    Type: 'AWS::IAM::Role'
  NSLambdaAccessRole:
    Condition: AnyFeatureEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
        Version: 2012-10-17
      Path: /
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - 'logs:*'
                Effect: Allow
                Resource:
                  - 'arn:aws:logs:*:*:*'
            Version: 2012-10-17
          PolicyName: LogAccess
    Type: 'AWS::IAM::Role'
  SecurityScanRolePolicy:
    Condition: SecurityScanEnabled
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:ListBucket'
              - 'ses:ListIdentityPolicies'
              - 's3:GetBucketAcl'
              - 's3:GetBucketLocation'
              - 's3:ListAllMyBuckets'
              - 'dynamodb:ListTagsOfResource'
              - 'sqs:ListDeadLetterSourceQueues'
              - 'sqs:GetQueueUrl'
              - 'sqs:GetQueueAttributes'
              - 'lambda:Get*'
              - 'lambda:List*'
            Effect: Allow
            Resource:
              - '*'
        Version: 2012-10-17
      PolicyName: netskope-csa
      Roles:
        - !Ref CrossAccountRole
    Type: 'AWS::IAM::Policy'
  StorageScanPolicy:
    Condition: StorageScanEnabled
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sns:Subscribe'
              - 'sns:Unsubscribe'
              - 'sns:ConfirmSubscription'
              - 's3:ListAllMyBuckets'
              - 's3:ListBucket'
              - 's3:GetObject'
              - 's3:GetObjectAcl'
              - 's3:GetBucketLocation'
              - 'cloudtrail:DescribeTrails'
              - 'ec2:DescribeRegions'
              - 'iam:ListAccountAliases'
            Effect: Allow
            Resource:
              - '*'
        Version: 2012-10-17
      PolicyName: StorageScanPolicy
      Roles:
        - !Ref CrossAccountRole
    Type: 'AWS::IAM::Policy'</pre></section><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4666905054798431739621554144"><div class="titlepage"><div><div class="title"><h6 class="title">Import the CFT to AWS Management Console</h6></div></div></div><p>Import <code class="literal">add_accounts_cft.yml</code> to a new CloudFormation stack in each AWS account. To import the CFT,</p><div class="procedure" id="UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_procedure-idm4575661925019231717399568885"><ol class="procedure" type="1"><li class="step"><p>Log in to the AWS Management Console using the credentials of the AWS account you are setting up with Netskope for IaaS and navigate to <span class="bold bold"><strong>Services &gt; CloudFormation</strong></span>.</p></li><li class="step"><p>In the CloudFormation page, click <span class="bold bold"><strong>Create stack</strong></span>.</p></li><li class="step"><p>Select <span class="bold bold"><strong>Upload a template file</strong></span> and click <span class="bold bold"><strong>Choose file</strong></span> to upload the <code class="literal">add_accounts_cft.yml</code> . Click <span class="bold bold"><strong>Next</strong></span>.</p><div class="mediaobject"><img src="image/uuid-6c51ccae-1b7e-09d8-7b6d-864c05caaec4-en.png" style="" alt="auto-add-cft_aws1.png"></img></div></li><li class="step"><p>In the Specify stack details page, specify a <span class="bold bold"><strong>Stack name</strong></span>.</p><p>The stack name must:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Only contain alphanumeric characters and hyphens,</p></li><li class="listitem"><p>start with an alphabet, and</p></li><li class="listitem"><p>not be longer than 128 characters.</p></li></ul></div></li><li class="step"><p>Define the parameters in the template and click <span class="bold bold"><strong>Next</strong></span>. For information, see <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4554783205508831739625303302" title="Provide input parameters in the stack details page"><span class="xreftitle">Provide input parameters in the stack details page</span></a>.</p><div class="mediaobject"><img src="image/uuid-a9bc19b8-1fa2-c5c5-6819-4a6ce7216b30-en.png" style="" alt="auto-add-cft_aws2.png"></img></div></li><li class="step"><p>In the Configure stack options page, use the default configuration, and click <span class="bold bold"><strong>Next</strong></span>.</p></li><li class="step"><p>Review your stack details on the <span class="bold bold"><strong>Review</strong></span> page, click the acknowledgment and then click <span class="bold bold"><strong>Create stack</strong></span>.</p><p>When the creation process is complete, your stack will be displayed on the CloudFormation page and the AWS account will be setup in the Netskope tenant with the services specified in the <code class="literal">add_accounts_cft.yml</code>.</p></li></ol></div></section><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4554783205508831739625303302"><div class="titlepage"><div><div class="title"><h6 class="title">Provide input parameters in the stack details page</h6></div></div></div><p>You must provide the following input parameters in the stack created using <code class="literal">add_accounts_cft.yml</code> to set up the AWS account with Netskope's Public Cloud Security features such a Continuous Security Assessment and Storage Scan.</p><div class="informaltable table-responsive"><table class="informaltable table-bordered"><thead><tr><th class="th" data-priority="1"><p>Parameter</p></th><th class="th" data-priority="1"><p>Value</p></th></tr></thead><tbody><tr><td class="td"><p>APIToken</p></td><td class="td"><p>Enter Netskope's REST API token.</p></td></tr><tr><td class="td"><p>AccountName</p></td><td class="td"><p>Enter an AWS account name, preferably the AWS account alias.</p></td></tr><tr><td class="td"><p>AdminEmail</p></td><td class="td"><p>This parameter is optional. Enter an admin email.</p></td></tr><tr><td class="td"><p>DLPScan</p></td><td class="td"><p>Set to <code class="literal">true</code> by default to enable DLP scans. To disable DLP scans, enter <code class="literal">false</code>.</p></td></tr><tr><td class="td"><p>ExternalID</p></td><td class="td"><p>Contact <a class="link" href="mailto:support@netskope.com" target="_blank">Netskope support</a> to get the External ID.</p></td></tr><tr><td class="td"><p>MalwareScan</p></td><td class="td"><p>Set to <code class="literal">true</code> by default to enable threat and malware scans. To disable threat and malware scans, enter <code class="literal">false</code>.</p></td></tr><tr><td class="td"><p>SecurityScan</p></td><td class="td"><p>Set to <code class="literal">true</code> by default to enable security assessment scans. To disable security assessment scans, enter <code class="literal">false</code>.</p></td></tr><tr><td class="td"><p>SecurityScanInterval</p></td><td class="td"><p>The default scan interval is set to 60 minutes. You can change the interval time in minutes to one of the following values.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>30</p></li><li class="listitem"><p>120</p></li><li class="listitem"><p>360</p></li><li class="listitem"><p>1440</p></li></ul></div></td></tr><tr><td class="td"><p>TenantUrl</p></td><td class="td"><p>Enter Netskope's tenant URL.</p></td></tr><tr><td class="td"><p>TrustedAccountID</p></td><td class="td"><p>Contact <a class="link" href="mailto:support@netskope.com" target="_blank">Netskope support</a> to get the Trusted Account ID.</p></td></tr></tbody></table></div></section></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-6d2030e9-5471-ddf1-13a7-453e98dba5a1" data-time-modified="June 19, 2020" data-publication-date="" id="UUID-ecc7dde9-7bdc-8d52-5ca7-fad099684de9"><div class="titlepage"><div><div class="title"><h6 class="title">Update AWS accounts in Netskope from AWS Management Console</h6></div></div></div><p>To enable or disable Netskope services on AWS accounts and edit other input parameters in the stack you created using <code class="literal">add_accounts_cft.yml</code>,</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into the AWS Management Console using the credentials of the AWS account you want to update and navigate to <span class="bold bold"><strong>Services &gt; CloudFormation</strong></span>.</p></li><li class="listitem"><p>Click on the stack created using <code class="literal">add_accounts_cft.yml</code> and click <span class="bold bold"><strong>Update</strong></span>.</p></li><li class="listitem"><p>In the Update stack page, select <span class="bold bold"><strong>Use current template</strong></span> and click <span class="bold bold"><strong>Next</strong></span>.</p></li><li class="listitem"><p>In the Specify stack details page, edit the parameters. For instance, if you want to disable threat and malware scans, set the value of MalwareScan to <code class="literal">false</code>. Click <span class="bold bold"><strong>Next</strong></span>.</p><p>For information, see "Provide input parameters in the stack details page" section in <a class="xref" href="setting-up-multiple-aws-accounts-using-the-new-ui.html#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237" title="Automatically add new accounts to Netskope"><span class="xreftitle">Automatically add new accounts to Netskope</span></a>.</p></li><li class="listitem"><p>In the Configure stack options page, use the default configuration, and click <span class="bold bold"><strong>Next</strong></span>.</p></li><li class="listitem"><p>Review your stack details on the <span class="bold bold"><strong>Review</strong></span> page, click the acknowledgment and then click <span class="bold bold"><strong>Update stack</strong></span>.</p></li></ol></div></section><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-bafdc236-91e2-1931-4a66-a7d51e2a2b91" data-time-modified="June 19, 2020" data-publication-date="" id="UUID-75b5402a-3690-4398-3369-4e874fa66033"><div class="titlepage"><div><div class="title"><h6 class="title">Delete AWS accounts in Netskope from AWS Management Console</h6></div></div></div><p>To delete AWS accounts in the Netskope tenant from the from AWS Management Console,</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into the AWS Management Console using the credentials of the AWS account you want to delete from the Netskope tenant and navigate to <span class="bold bold"><strong>Services &gt; CloudFormation</strong></span>.</p></li><li class="listitem"><p>Select the stack created using <code class="literal">add_accounts_cft.yml</code> and click <span class="bold bold"><strong>Delete</strong></span>.</p></li></ol></div></section></section><div class="footer-content"><div class="section-toc section-toc-after"><div class="section-toc-title">In this section<span class="section-toc-title-delimiter">: </span></div></div><div class="glossary-definitions"></div></div><footer></footer></div></article><aside class="section-nav-container"><ul class="section-nav nav"><li><a href="#UUID-8ae50cf1-2631-d87e-90f1-0e6a65808f95">Setting Up Multiple AWS Accounts using the New UI</a></li><li><a href="#UUID-8ae50cf1-2631-d87e-90f1-0e6a65808f95_section-idm4656990448473631604936702596">Prerequisites</a></li><li><a href="#UUID-b1c66578-32b0-c7c9-607d-7e9fbd9a864b">Implementation guide to set up AWS accounts in Netskope</a></li><li><a href="#UUID-2d7b0ea4-a8fc-e720-9bea-4b9f9e60905d">Add AWS accounts to Netskope using the Netskope UI</a><ul class="nav"><li><a href="#UUID-a9a92cb1-41dd-86a1-90c8-f02f8bc0094b">Step 1/2: Accounts &amp; Services</a><ul class="nav"></ul></li><li><a href="#UUID-a2c824c8-ae71-c6a4-9f9c-00b8f6db4bb4">Step 2/2: Permissions</a><ul class="nav"></ul></li></ul></li><li><a href="#UUID-837c1dce-98ef-6fb4-c730-eb6743e20c4e">Scanning S3 Buckets encrypted with KMS keys</a></li><li><a href="#UUID-4519cdf2-b7a0-5757-a29f-375a73f3e2a0">Post set up updates</a><ul class="nav"><li><a href="#UUID-4519cdf2-b7a0-5757-a29f-375a73f3e2a0_section-idm4531670245500831610354701455">Updating the stack</a></li></ul></li><li><a href="#UUID-ff88d934-8f56-2761-8744-ca46615deedd">Migrate existing AWS accounts to the new set up</a><ul class="nav"><li><a href="#UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4554778600416031741635094502">Bulk migrate using migration_script.py</a><ul class="nav"></ul></li><li><a href="#UUID-ff88d934-8f56-2761-8744-ca46615deedd_section-idm4568085658176031741635417598">Manually migrate each account using aws-instance-setup.yml</a></li></ul></li><li><a href="#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237">Automatically add new accounts to Netskope</a><ul class="nav"><li><a href="#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4646577699496031739621375452">Create the CFT file</a></li><li><a href="#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4666905054798431739621554144">Import the CFT to AWS Management Console</a></li><li><a href="#UUID-bd1cdb04-1e79-2d2f-ef1f-7a426c7f3237_section-idm4554783205508831739625303302">Provide input parameters in the stack details page</a></li></ul></li><li><a href="#UUID-ecc7dde9-7bdc-8d52-5ca7-fad099684de9">Update AWS accounts in Netskope from AWS Management Console</a></li><li><a href="#UUID-75b5402a-3690-4398-3369-4e874fa66033">Delete AWS accounts in Netskope from AWS Management Console</a></li></ul></aside><article id="search-result-wrapper"><div class="search-container" style="display: none;"><h2>Search results</h2><ul class="searchresults"></ul><p class="noresults">No results found</p></div></article><div class="feedback-panel"><div id="email-feedback" class="no-voting toggle-feedback"><p><a href="mailto:techpubs@netskope.com?subject=Feedback%20for%20help%20topic%20%22Setting%20Up%20Multiple%20AWS%20Accounts%20using%20the%20New%20UI%22&amp;body=%0A%09%09%09%09%0A%09%09%09%09%0A%09%09%09%09_______________________%0A%09%09%09%09%0A%09%09%09Please%20add%20your%20feedback%20above%20for%20topic%20%22Setting%20Up%20Multiple%20AWS%20Accounts%20using%20the%20New%20UI%22%20in%20the%20publication%20%22Netskope%20Help%22."><i aria-hidden="true" class="fa fa-pencil-square-o feedbackicon"></i>Would you like to provide feedback? Just click here to suggest edits.</a></p></div></div></main><div id="bottom-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="continuous-security-assessment-for-aws.html">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="setting-up-aws-instances-using-old-ui.html">Next</a></li></ul></div><footer class="site-footer"><div class="inner"><div class="copyright"> © 2021 Netskope </div><div class="date-modified"><span class="date-modified-text">Last modified: </span><span class="formatted-date">December 16, 2020</span></div><div class="publication-date"><span class="publication-date-text">Publication date</span><span class="pubdate-delimiter">: </span><span class="formatted-date"></span></div></div></footer></div></div></div></div></body></html>
