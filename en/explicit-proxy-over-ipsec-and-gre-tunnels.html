<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="x-ua-compatible" content="IE=edge"></meta><meta name="format-detection" content="telephone=no"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"></meta><meta name="search" content="default"></meta><meta name="use.ic" content="no"></meta><meta name="tocstandalone" content="yes"></meta><meta name="theme" content="1"></meta><meta name="search.placeholder" content="Search"></meta><meta name="search.results" content="Search results"></meta><meta name="no.search.results" content="No results found"></meta><script type="text/javascript">
var theme = '1';

			
			var versionsfile = '';


			var indexDict = new Array();
			var store = {};
			var portalLanguage = 'en';
			var enterKey = 'select';
			
			
				var fuse_threshold = 0.3;
			
					var local_csh = false;
				
					var anchoroption = true;
				
			
			var useanchorlinks = false;
			
				useanchorlinks = true;
				
				var clicktocopy = 'Click to copy link';
				var linkcopied =  'Copied!';</script><title>Explicit Proxy over IPSec and GRE Tunnels</title><link rel="stylesheet" type="text/css" href="../css/docbook.css"></link><link rel="stylesheet" type="text/css" href="../css/font-awesome.css"></link><link rel="stylesheet" type="text/css" href="../css/roboto.font.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1-colors.css"></link><link rel="stylesheet" type="text/css" href="../css/content-theme2.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-core-css.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-simple.css"></link><link rel="stylesheet" type="text/css" href="../css/style-print.css"></link><link rel="stylesheet" type="text/css" href="../css/style-common.css"></link><link rel="stylesheet" type="text/css" href="../css/style-modern-tables.css"></link><link rel="stylesheet" type="text/css" href="../css/rwd-table.min.css"></link><link rel="stylesheet" type="text/css" href="../css/graphical-lists.css"></link><link rel="stylesheet" type="text/css" href="../css/layout-custom-style.css"></link><script src="../js/jquery-3/jquery-3.4.1.min.js" type="text/javascript"></script><script src="../js/jquery-migrate-3.0.1.min.js" type="text/javascript"></script><script src="../js/materialize.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/purl.js" type="text/javascript"></script><script src="../js/jquery.smartmenus.js" type="text/javascript"></script><script src="js/toc.js" type="text/javascript"></script><script src="../js/create-toc.js" type="text/javascript"></script><script src="../js/html5-2-mp-common.js" type="text/javascript"></script><script src="../js/html5-2.js" type="text/javascript"></script><script src="../js/checklist.js" type="text/javascript"></script><script src="../js/rwd-table.min.js" type="text/javascript"></script><script src="../js/responsive-tables.js" type="text/javascript"></script><script src="../js/clipboard.min.js" type="text/javascript"></script><script src="../js/anchorlinks.js" type="text/javascript"></script><script src="../js/lunr.js" type="text/javascript"></script><script src="../js/jquery.mark.min.js" type="text/javascript"></script><script src="js/data.js" type="text/javascript"></script><script src="../js/search.js" type="text/javascript"></script><script src="../js/csh.js" type="text/javascript"></script><script src="../js/layout-custom-script.js" type="text/javascript"></script><meta name="generator" content="Paligo"></meta><link rel="prev" href="explicit-proxy-217835.html#UUID-aef1dfc7-d479-b6f8-7298-9bba7ae70e1f_section-idm231895294666809" title="PAC File Template"></link><link rel="next" href="proxy-chaining-236707.html" title="Proxy Chaining"></link><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" async="async"></script><link rel="icon" href="/favicon.ico" type="image/x-icon"></link><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZT8KHXMB6T"></script><script type="text/javascript">var propertyid = 'G-ZT8KHXMB6T';

						window.dataLayer = window.dataLayer || [];
						function gtag(){dataLayer.push(arguments)};
						gtag('js', new Date());
						
						gtag('config', propertyid);
					</script><script type="text/javascript">
				$(document).ready(function () {
				$(".mediaobject img").addClass('materialboxed');
				//Exclude images with links
				$(".mediaobject a img").removeClass('materialboxed');
				if (!document.documentMode) {
				$('.materialboxed').materialbox();
				}});
			</script></head><body class="theme1 fixed-toolbar colored-top page-toc current-toc-section-focus" data-spy="scroll" data-target=".section-nav-container" data-offset="100" data-link-prefix=""><header class="site-header"><nav class="site-header-navbar navbar navbar-fixed-top"><div class="navbar-container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div id="logotype-container" class="pull-left"><a class="navbar-brand" href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div></div><div id="navbar" class="navbar-collapse collapse"></div></div></nav></header><div class="site-body"><div class="site-body-container"><div class="site-body-row"><aside class="site-sidebar"><div class="site-sidebar-header"><button type="button" class="navbar-toggle" aria-controls="nav-site-sidebar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div><form class="site-sidebar-search" autocomplete="off"><input type="text" class="form-control search-field" placeholder="Search" id="aa-search-input"></input></form><div id="toc-standalone-placeholder"></div></aside><div class="site-content"><h1 class="publication-title">Netskope Help</h1><div class="toolbar"><div class="toolbar-tools"><div id="navbar" class="navbar-collapse collapse"></div><div class="tool-print print-icon"><a onclick="window.print();return false;"><i class="fa fa-print" aria-hidden="true"><span class="print-text">print</span></i></a></div><div class="tool-search"><i class="fa fa-search" aria-hidden="true"></i></div><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div class="breadcrumb-container"><ul class="breadcrumb"><li class="breadcrumb-link"> <a href="index-en.html">Netskope Help</a></li><li class="breadcrumb-link"><a href="traffic-management.html">Traffic Management</a></li><li class="breadcrumb-link"><a href="traffic-steering.html">Traffic Steering</a></li><li class="breadcrumb-node">Explicit Proxy over IPSec and GRE Tunnels</li></ul></div></div><main><div id="top-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="explicit-proxy-217835.html#UUID-aef1dfc7-d479-b6f8-7298-9bba7ae70e1f_section-idm231895294666809">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="proxy-chaining-236707.html">Next</a></li></ul></div><article class="topic content-container" id="content-wrapper"><div id="topic-content" class="topic-content"><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-3182b2ee-f487-cfb9-f0d9-80c3093ba30f" data-permalink="explicit-proxy-over-ipsec-and-gre-tunnels.html" data-topic-level="1" data-relative-prefix="" data-time-modified="November 2, 2020" data-publication-date="" id="UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16"><div class="titlepage"><div><div class="title"><h4 class="title">Explicit Proxy over IPSec and GRE Tunnels</h4></div></div></div><p>In certain cases, you may want to use explicit proxy over IPSec or GRE tunnels. For example:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>There is an existing proxy PAC file in place and you want to use it for exceptions, and other configurations are already scripted into the PAC file.</p></li><li class="listitem"><p>There’s a current resource limitation in the IPSec or GRE tunnel origin gear, and you want to limit the number of ACL’s/Objects required to get traffic to the cloud. The PAC file, as noted in the first point, already contains most of that information, if not all.</p></li><li class="listitem"><p>Often administrators do not want to manipulate servers by installing a client, or server subnets by directing them through tunnels due to their critical nature to the business. Explicit proxy is an excellent alternative to and can be set and locked down using a number of methods (GPO, for instance).</p></li><li class="listitem"><p>Explicit proxy is browser-centric. While Windows and OS X have OS-based proxy settings, these generally work fine (see <a class="link" href="explicit-proxy-over-ipsec-and-gre-tunnels.html#UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16_bridgehead-idm231884965232367" title="FAQ">FAQ</a>), and all operating systems can install browsers that are OS agnostic (like FireFox) when it comes to explicit proxy. This means you can cover platforms that are currently not supported by the Netskope Client like Linux with explicit proxy.</p></li></ul></div><p>You can use an existing or new PAC file, or manual proxy settings, over IPSec or GRE tunnels with the Netskope Platform.</p><p>For example:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The explicit proxy configuration points HTTP/HTTPS traffic to this reserved IP address <code class="literal">163.116.128.80</code> on port 8080, either manually or via a PAC file.</p></li><li class="listitem"><p>The session is redirected down the IPSec or GRE tunnel by the access list on the firewall or router matching on port <code class="literal">8080</code>, which terminates at the Netskope IPSec or GRE headend.</p></li><li class="listitem"><p>The cloud forward proxy sees the request (more specifically, the HTTP request method) incoming on port 8080 and routes it to the appropriate cloud service on port 80 or 443 for proxying.</p></li></ul></div><p>The test is set up as shown:</p><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:540px;
                            "><tr><td style="padding:0;"><img src="image/uuid-186c820d-54f4-dcba-5f35-7df4e965a7fa.png" style="max-width: 540px; " alt="image1.png"></img></td></tr></table></div><p>For this first test, Firefox 74.0 (64-bit) on Windows 10 is being used due to its ease of proxy configuration (other browsers on Windows tend to use the OS proxy settings) with the following settings:</p><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:540px;
                            "><tr><td style="padding:0;"><img src="image/uuid-c5432742-2bf1-f692-83cf-6387e3c63ad2.png" style="max-width: 540px; " alt="image2.png"></img></td></tr></table></div><p>The IP address <code class="literal">163.116.128.80</code> used is reserved for explicit proxy.</p><p>Domains that should not be sent to the proxy can be configured here as well. In this instance, <code class="literal">.bestcasinosites.net</code>, .<code class="literal">zoom.com</code>, <code class="literal">.zoom.us</code> and <code class="literal">.lastpass.com</code>; notice <span class="emphasis"><em>no</em></span> wildcard. The first site is for testing the bypass to avoid blocking; the last three sites are for ensuring that those services are not intercepted and broken by the explicit proxy.</p><p>The traffic is being sent over an IPSec tunnel that can be created by any capable CPE (customer premise equipment) to the Netskope cloud; see the Netskope UI for supported versions/ciphers, etc.</p><div dir="ltr" class="important"><h3 class="title">Important</h3><p><code class="literal">8080</code> traffic <span class="emphasis"><em>must</em></span> be sent to the cloud over the tunnel via access lists for this to work properly.</p></div><p>Three test cases will be tested to show the different identities shown in SkopeIT, as well as the different internal IP’s being captured, just as they would be over an IPSec or GRE tunnel without explicit proxy.</p><h5 id="UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16_bridgehead-idm231884909838407" class="bridgehead">Test Case 1 – Single Workstation, No Netskope Client</h5><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:540px;
                            "><tr><td style="padding:0;"><img src="image/uuid-df9ac7a0-b93d-c580-452b-e402ba4f5063.png" style="max-width: 540px; " alt="image3.png"></img></td></tr></table></div><p>As expected, the access method is IPSec and the identity is reported as the internal IP address of the workstation. The traffic is going over <code class="literal">8080</code>, an ACL is redirecting <code class="literal">8080</code> down the tunnel, and the Netskope Forward Proxy intercepts and blocks based on a policy prohibiting Gambling sites.</p><h5 id="UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16_bridgehead-idm231884913394926" class="bridgehead">Test Case 2 – Two Workstations, No Netskope Clients</h5><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:540px;
                            "><tr><td style="padding:0;"><img src="image/uuid-346068a8-b4f6-29f0-7c01-0d357628f884.png" style="max-width: 540px; " alt="image4.png"></img></td></tr></table></div><p>In this scenario, two Windows 10 workstations are going over an IPSec tunnel, both using Firefox configured for explicit proxy. The internal IP address is properly identified from both, and is the only identity provided. The access method is seen as IPSec.</p><h5 id="UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16_bridgehead-idm231884914961741" class="bridgehead">Test Scenario 3 – Two Workstations, One With Netskope Client, One Without</h5><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:540px;
                            "><tr><td style="padding:0;"><img src="image/uuid-2797a3ab-69ef-45e3-e06a-6aa6d988d308.png" style="max-width: 540px; " alt="image5.png"></img></td></tr></table></div><p>As shown, the workstation with the Netskope client is still showing IPSec as the access method, but the username is being captured along with the internal IP. The Netskope Client on this workstation shows as such:</p><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:360px;
                            "><tr><td style="padding:0;"><img src="image/uuid-bc9d7dc4-a63f-941e-db3b-72c17933c21f.png" style="max-width: 360px; " alt="image6.png"></img></td></tr></table></div><p>The Client detects the tunnel and upstream proxy, and while the Client steering is deactivated, it continues to pass on identity information (this particular client was enrolled via SAML 2.0/Okta User Enrollment).</p><p>The host without the Client continues to show only the Internal IP address as the identity:</p><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:540px;
                            "><tr><td style="padding:0;"><img src="image/uuid-4d3851a7-119f-ce63-881d-886b566a26c8.png" style="max-width: 540px; " alt="image7.png"></img></td></tr></table></div><p>As an additional example, a PAC file has been created (see <a class="xref" href="explicit-proxy-over-ipsec-and-gre-tunnels.html#UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16_bridgehead-idm231885008074025" title="Explicit Proxy PAC File Example"><span class="xreftitle">Explicit Proxy PAC File Example</span></a>) and applied with the following settings/exceptions as shown here:</p><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:540px;
                            "><tr><td style="padding:0;"><img src="image/uuid-0eb390da-5606-6823-3167-82af6ef5d05e.png" style="max-width: 540px; " alt="image8.png"></img></td></tr></table></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Points to <code class="literal">163.116.128.80:8080</code> for HTTP/HTTPS</p></li><li class="listitem"><p>No proxy for <code class="literal">https://www.bestcasinosites.net</code> (take it DIRECT). The test policy blocks Gambling, but this statement will allow this domain by not sending it to the explicit proxy</p></li><li class="listitem"><p>DIRECT statement for fail through in case of any issues with upstream proxy (tunnel goes down, for instance).</p></li></ul></div><p>Before applying the PAC to the browser, the above mentioned site resulted in a block (notice timestamp):</p><div class="mediaobject"><table class="image-viewport" style="border-collapse:collapse;border:0;
                                width:270px;
                            "><tr><td style="padding:0;"><img src="image/uuid-47d31a05-8c29-25ae-b396-89c9e7e47d93.png" style="max-width: 270px; " alt="image9.png"></img></td></tr></table></div><p>With the PAC file in place containing <span class="emphasis"><em>do not proxy</em></span> for <code class="literal">bestcasinosites.net</code>, the request was sent direct via the native port <code class="literal">443</code>, not <code class="literal">8080</code>, and therefore was <span class="emphasis"><em>not</em></span> sent down the tunnel to the forward proxy and blocked. This resulted in access to the site, as well as no log entry in SkopeIT.</p><p>In summary, explicit proxy over IPSec or GRE works as expected, applying all manual settings or the PAC config, and the tunnel behaves as it would in any other scenario (action determined by access lists). The internal IP addresses are tracked properly, and while the Client deactivates intelligently due to a protected site, the Client adds identity while also listing the correct internal IP address.</p><h5 id="UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16_bridgehead-idm231884965232367" class="bridgehead">FAQ</h5><p>Q. Can I use any browser to achieve this?</p><p>A. Yes, but there are exceptions based on the OS.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>On Linux/Mac, any browser should work just fine using manual explicit configurations in the OS, the browser (if available), or a PAC file.</p></li><li class="listitem"><p>On Windows 10, there’s a known issue with FTP and File protocols if hosting the PAC file on the host itself. See <a class="link" href="https://support.microsoft.com/en-us/help/4025058/windows-10-does-not-read-a-pac-file-referenced-by-a-file-protocol" target="_blank" rel="noopener">Windows 10 does not read a PAC file referenced by a file protocol</a> for more information.</p></li></ol></div><p>Q. Do I have to use the provided IP for explicit proxy?</p><p>A. Yes, it is preferred that <code class="literal">163.116.128.80</code> is used when configuring explicit proxy. This IP address has been reserved specifically for this purpose.</p><p>Q. What ports can I configure to work with explicit proxy? Could I send FTP to the explicit proxy?</p><p>A. The only proxy settings currently supported are HTTP and HTTPS. All other traffic sent to the proxy will be dropped. Likewise, <code class="literal">80</code>, <code class="literal">443</code>, and <code class="literal">8080</code> are the only ports supported. All other port traffic will be dropped.</p><p>Q. Should you intercept all three ports using access lists on the router/firewall and send them down the IPSec or GRE tunnel?</p><p>A. No, for two reasons:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>You’ll effectively break the ability to bypass with the explicit proxy config. Let’s say you set a bypass as shown in the config above for <code class="literal">.bestcasinos.net</code>, and you’re blocking Gambling as a category. The request would bypass the explicit proxy on <code class="literal">8080</code>, and get sent over 443, and would get intercepted by the access list and be sent down the tunnel and then blocked, which negates the purpose of using the PAC/manual explicit proxy settings for bypass.</p></li><li class="listitem"><p>Simplification is a great use case for explicit proxy; rather than listen on all three ports, listening on one port simplifies the config on both the host and the router/firewall. As in this case, the PAC file often already exists, theres no need to change the configuration if already using 8080.</p></li></ol></div><h5 id="UUID-b31d989a-6797-9372-7cc0-598d1bc8ee16_bridgehead-idm231885008074025" class="bridgehead">Explicit Proxy PAC File Example</h5><p>This is the PAC file used for testing.</p><pre class="programlisting">function FindProxyForURL(url,host)
{
/* Convert all URLs to lower case, more consistent and better for pattern matching*/
url = url.toLowerCase();
host = host.toLowerCase();
/* Send all hosts with no FQDN direct to internet */
if (isPlainHostName(host))
{
return 'DIRECT';
}
/* Don't proxy IDP servers. */
/*
if ((dnsDomainIs(host, '.okta.com'))
{
return 'DIRECT'
}
*/
/* Send Zoom urls direct…if this is not used, proxy will break Zoom! */
if (dnsDomainIs(host, ".zoom.com") ||
(dnsDomainIs(host, ".zoom.us")))
{
return 'DIRECT';
}
/* Don’t send RFC1918 and a few others to the proxy */
If (isInNet(host, '10.0.0.0', '255.0.0.0') ||
isInNet(host, '127.0.0.0', '255.0.0.0') ||
isInNet(host, '169.254.0.0', '255.255.0.0') ||
isInNet(host, '172.16.0.0', '255.240.0.0') ||
isInNet(host, '192.168.0.0', '255.255.0.0')) ||
{
return 'DIRECT';
}
/* Send only http and https to proxy on :8080 *, bypass all else */
if (url.substring(0, 5) == 'http:' ||
url.substring(0, 6) == 'https:')
{
return 'PROXY 163.116.128.80:8080';
}
return 'DIRECT';
}</pre></section><div class="footer-content"><div class="section-toc section-toc-after"><div class="section-toc-title">In this section<span class="section-toc-title-delimiter">: </span></div></div><div class="glossary-definitions"></div></div><footer></footer></div></article><article id="search-result-wrapper"><div class="search-container" style="display: none;"><h2>Search results</h2><ul class="searchresults"></ul><p class="noresults">No results found</p></div></article><div class="feedback-panel"><div id="email-feedback" class="no-voting toggle-feedback"><p><a href="mailto:techpubs@netskope.com?subject=Feedback%20for%20help%20topic%20%22Explicit%20Proxy%20over%20IPSec%20and%20GRE%20Tunnels%22&amp;body=%0A%09%09%09%09%0A%09%09%09%09%0A%09%09%09%09_______________________%0A%09%09%09%09%0A%09%09%09Please%20add%20your%20feedback%20above%20for%20topic%20%22Explicit%20Proxy%20over%20IPSec%20and%20GRE%20Tunnels%22%20in%20the%20publication%20%22Netskope%20Help%22."><i aria-hidden="true" class="fa fa-pencil-square-o feedbackicon"></i>Would you like to provide feedback? Just click here to suggest edits.</a></p></div></div></main><div id="bottom-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="explicit-proxy-217835.html#UUID-aef1dfc7-d479-b6f8-7298-9bba7ae70e1f_section-idm231895294666809">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="proxy-chaining-236707.html">Next</a></li></ul></div><footer class="site-footer"><div class="inner"><div class="copyright"> © 2021 Netskope </div><div class="date-modified"><span class="date-modified-text">Last modified: </span><span class="formatted-date">November 2, 2020</span></div><div class="publication-date"><span class="publication-date-text">Publication date</span><span class="pubdate-delimiter">: </span><span class="formatted-date"></span></div></div></footer></div></div></div></div></body></html>
